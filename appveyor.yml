image: Visual Studio 2017

install:
  - docker version
  - ps: Start-FileDownload "https://static.rust-lang.org/rustup/dist/i686-pc-windows-gnu/rustup-init.exe"
  - rustup-init.exe -y --default-host i686-pc-windows-gnu
  - SET PATH=%PATH%;C:\Users\appveyor\.cargo\bin
  - SET PATH=%PATH%;C:\MinGW\bin
  - rustc -V
  - cargo -V

build_script:
  - ps: |
        $ipv4 = (Test-Connection -ComputerName $env:ComputerName -Count 1).IPV4Address.IPAddressToString
        Set-Item -path env:HOST_IP -value $ipv4
  - ipconfig
  - echo %HOST_IP%
  - ps: |
        cd dockerfiles/windows/registry 
        docker build -t stefanscherer/registry-windows -f Dockerfile .
        cd ../../../
  - ps: | 
        cd dockerfiles/windows/consul
        docker build -t stefanscherer/consul-windows -f Dockerfile .
        cd ../../../
  - docker run -d -p 5000:5000 --restart=always --name registry stefanscherer/registry-windows
  - cargo build --verbose 

test_script:
  - ps: Set-Item -path env:RUST_BACKTRACE -value 1
  - cargo test --verbose -- --nocapture --test-threads 1
